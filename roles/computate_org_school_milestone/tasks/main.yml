- name: "Get milestone by title {{ MILESTONE_TITLE | default(omit) }}"
  set_fact:
    MILESTONE_TITLE_JSON: "{{ MILESTONES.json | json_query(milestone_query) | first }}"
  when: MILESTONES.json | json_query(milestone_query)
  vars: 
    milestone_query: "[?title=='{{ MILESTONE_TITLE | default(omit) }}'].{title: title, description: description, number: number}"
  tags: milestone_title
- name: "Create milestone by title {{ MILESTONE_TITLE }}"
  uri:
    timeout: 90
    url: "https://api.github.com/repos/{{ GITHUB_ORG }}/{{ GITHUB_REPO }}/milestones"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "token {{ GITHUB_TOKEN }}"
    body_format: json
    body: 
      title: "{{ MILESTONE_TITLE }}"
      description: "{{ MILESTONE_DESCRIPTION }}"
    status_code: 
      - 200
      - 201
  when: MILESTONE_TITLE_JSON is not defined
  register: MILESTONE_CREATE_JSON
  tags: milestone_title
- name: "Update milestone by title {{ MILESTONE_TITLE }}"
  uri:
    timeout: 90
    url: "https://api.github.com/repos/{{ GITHUB_ORG }}/{{ GITHUB_REPO }}/milestones/{{ MILESTONE_TITLE_JSON.number }}"
    method: PATCH
    headers:
      Content-Type: "application/json"
      Authorization: "token {{ GITHUB_TOKEN }}"
    body_format: json
    body: 
      title: "{{ MILESTONE_TITLE }}"
      description: "{{ MILESTONE_DESCRIPTION }}"
  when: MILESTONE_TITLE_JSON is defined
  register: MILESTONE_CREATE_JSON
  tags: milestone_title

